package fail2ban

import (
	"context"
	"fmt"

	"github.com/spf13/cobra"
	
	"github.com/wasilwamark/vps-init/pkg/plugin"
)

type Plugin struct{}

func (p *Plugin) Name() string {
	return "fail2ban"
}

func (p *Plugin) Description() string {
	return "Protect against brute-force attacks"
}

func (p *Plugin) Author() string {
	return "VPS-Init"
}

func (p *Plugin) Version() string {
	return "0.0.1"
}

func (p *Plugin) Initialize(config map[string]interface{}) error {
	return nil
}

func (p *Plugin) Start(ctx context.Context) error {
	return nil
}

func (p *Plugin) Stop(ctx context.Context) error {
	return nil
}



func (p *Plugin) GetRootCommand() *cobra.Command {
	return nil
}
	// Enhanced plugin interface methods
func (p *Plugin) Validate() error {
	// TODO: Add plugin-specific validation logic
	return nil
}

func (p *Plugin) Dependencies() []plugin.Dependency {
	return []plugin.Dependency{
		// TODO: Add plugin dependencies with version constraints
	}
}

func (p *Plugin) Compatibility() plugin.Compatibility {
	return plugin.Compatibility{
		MinVPSInitVersion: "1.0.0",
		GoVersion:         "1.19",
		Platforms:         []string{"linux/amd64", "linux/arm64"},
		Tags:              []string{"TODO", "add", "relevant", "tags"},
	}
}

func (p *Plugin) GetMetadata() plugin.PluginMetadata {
	return plugin.PluginMetadata{
		Name:        p.Name(),
		Description: p.Description(),
		Version:     p.Version(),
		Author:      p.Author(),
		License:     "MIT",
		Repository:  "github.com/wasilwamark/vps-init-plugins/" + p.Name(),
		Tags:        []string{"TODO", "add", "tags"},
		Validated:   true,
		TrustLevel:  "official",
		BuildInfo: plugin.BuildInfo{
			GoVersion: "1.21",
		},
	}
}


func (p *Plugin) GetCommands() []plugin.Command {
	return []plugin.Command{
		{
			Name:        "install",
			Description: "Install Fail2Ban and configure SSH jail",
			Handler:     p.installHandler,
		},
		{
			Name:        "status",
			Description: "Show service status and jails",
			Handler:     p.statusHandler,
		},
		{
			Name:        "banned",
			Description: "List banned IPs (default: sshd jail)",
			Handler:     p.bannedHandler,
		},
		{
			Name:        "unban",
			Description: "Unban an IP address",
			Handler:     p.unbanHandler,
		},
	}
}

func (p *Plugin) installHandler(ctx context.Context, conn plugin.Connection, args []string, flags map[string]interface{}) error {
	fmt.Println("ğŸ›¡ï¸  Installing Fail2Ban...")
	pass := getSudoPass(flags)

	// Update & Install
	// Split into separate commands because RunSudo logic might not handle && well if not wrapped in sh -c
	result := conn.RunSudo("apt-get update", pass); if !result.Success {
		return fmt.Errorf("failed to update apt: %s", result.Stderr)
	}
	result = conn.RunSudo("apt-get install -y fail2ban", pass); if !result.Success {
		return fmt.Errorf("failed to install fail2ban: %s", result.Stderr)
	}

	// Ensure service is running
	result = conn.RunSudo("systemctl enable fail2ban", pass); if !result.Success {
		return fmt.Errorf("failed to enable fail2ban: %s", result.Stderr)
	}
	result = conn.RunSudo("systemctl start fail2ban", pass); if !result.Success {
		return fmt.Errorf("failed to start fail2ban: %s", result.Stderr)
	}

	fmt.Println("âœ… Fail2Ban installed and running.")
	return nil
}

func (p *Plugin) statusHandler(ctx context.Context, conn plugin.Connection, args []string, flags map[string]interface{}) error {
	return conn.RunInteractive("sudo fail2ban-client status")
}

func (p *Plugin) bannedHandler(ctx context.Context, conn plugin.Connection, args []string, flags map[string]interface{}) error {
	jail := "sshd"
	if len(args) > 0 {
		jail = args[0]
	}

	fmt.Printf("ğŸ” Checking banned IPs for jail '%s'...\n", jail)
	// We use grep to filter just the IP list if possible, or just show the status which contains it.
	// status <jail> shows "Currently banned: <list>"

	cmd := fmt.Sprintf("sudo fail2ban-client status %s", jail)
	return conn.RunInteractive(cmd)
}

func (p *Plugin) unbanHandler(ctx context.Context, conn plugin.Connection, args []string, flags map[string]interface{}) error {
	if len(args) < 1 {
		return fmt.Errorf("usage: unban <ip> [jail]")
	}

	ip := args[0]
	jail := "sshd"
	if len(args) > 1 {
		jail = args[1]
	}

	fmt.Printf("ğŸ”“ Unbanning %s from %s...\n", ip, jail)
	cmd := fmt.Sprintf("sudo fail2ban-client set %s unbanip %s", jail, ip)

	return conn.RunInteractive(cmd)
}

// Helper
func getSudoPass(flags map[string]interface{}) string {
	if v, ok := flags["sudo-password"]; ok {
		return v.(string)
	}
	return ""
}
